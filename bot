#!/usr/bin/env bash

## VARIABLES
THIS_DIR=$(cd "$(dirname "$0")"; pwd)
TDCLI='https://valtman.name/files/telegram-cli-1222'

## Print Colorful
# Print text in red
prtred() {
  printf '\e[1;31m%s\n\e[0;39;49m' "$@"
}
# Print text in green
prtgrn() {
  printf '\e[1;32m%s\n\e[0;39;49m' "$@"
}
# Print text in brown
prtbrown() {
  printf '\e[1;33m%s\n\e[0;39;49m' "$@"
}
# update data to the last version
update() {
  git fetch --all && git reset --hard origin/persian && git pull origin persian && chmod +x bot
    prtgrn "
      »—Ê“—”«‰Ì «ÿ·«⁄«  »« „Ê›ﬁÌ  «‰Ã«„ ‘œ <<
  >> Bot's source successfully updated
"
}
# Create a new Bot
create() {
  name=bot
  if [[ -e $name.lua ]] ; then
      i=1
      while [[ -e $name-$i.lua ]] ; do
          let i++
      done
      name=$name-$i
  fi
  cat bot.lua >> "$name".lua
  sed -i 's/BOT-ID/'$i'/g' "$name".lua
    prtgrn "
     —»«  ‘„«—Â "$i" ”«Œ Â ‘œ <<
  : —»«  «‰ —« »« ›—„«‰ “Ì— «Ã—« ò‰Ìœ
>> new bot seccessfuly created
       bot number "$i"
      run your bot by :"
prtred "
       ./bot "$i"
"
}
# Create a new Bot manually
createmanual() {
   prtgrn '
        »—«Ì ”«Œ  —»«  »« ‘„«—Â œ·ŒÊ«Â° ‘„«—Â œ·ŒÊ«Â ŒÊœ —« Ê«—œ ò‰Ìœ <<
  >> To creating a new bot manually, Inter the BOT-ID :
'
  read -rp ' ' ID
    if [[ -e bot-"$ID".lua ]] ; then
      prtred '
     ‘„«—Â —»«  Ê«—œ ‘œÂ «“ ﬁ»· ÊÃÊœ œ«—œ <<
  >> There is a bot with this number ID
'
      exit
    else
      if [[ "$ID" =~ ^[0-9]+$ ]] ; then
        cat bot.lua >> bot-"$ID".lua
        sed -i 's/BOT-ID/'$ID'/g' bot-"$ID".lua
        prtgrn "
     —»«  ‘„«—Â "$ID" ”«Œ Â ‘œ <<
    : —»«  «‰ —« »« ›—„«‰ “Ì— «Ã—« ò‰Ìœ
  >> new bot seccessfuly created
       bot number "$ID"
      run your bot by :"
        prtred "
             ./bot "$ID"
      "
      else
        prtred "
     ‘„«—Â —»«  —« Ê«—œ ò‰Ìœ -- ⁄œœ
  Inter the bot number --integer
    "
        exit
      fi
    fi
}
# Reset data to the last update
fix() {
  git reset --hard FETCH_HEAD
  prtgrn '
  »«“Ì«»Ì «ÿ·«⁄«  »Â ¬Œ—Ì‰ ¬ÅœÌ  «‰Ã«„ ‘œ <<
  >> Database Reseted and Fixed
'
}
# autolauncher
autolaunch() {
  while true ; do
    for tablighgar in bot-*.lua ; do
      tab="${tablighgar%.*}"
      ltab="${tab/-/ }"
      tmux kill-session -t $tab
      for tg in ~/.telegram-cli/$tab/data/* ; do
        rm -rf $tg/*
      done
      TMUX= tmux new-session -d -s $tab "./$ltab"
      tmux detach -s $tab
    done
    echo -e " \n\e[1;32m—»«  Â« —«Â «‰œ«“Ì ‘œ‰œ << \e[1;34m| Naji |\e[1;32m>> Bots are Running\n\e[0;39;49m"
    sleep 1200
  done 
}
# clear a bot
clear() {
  sudo service redis-server start
  prtgrn '
       : ‘„«—Â ‘‰«”Â  »·Ì€ùê—Ì òÂ „ÌùŒÊ«ÂÌœ Å«ò ò‰Ìœ —« Ê«—œ ò‰Ìœ  <<
  >> Inter the BOT-ID,that you wanna delete :
'
  read -rp ' ' ID
  rm -rf ~/.telegram-cli/bot-"$ID"/data
  rm -rf bot-"$ID".lua
  redis-cli --raw keys "bot"$ID* | xargs redis-cli del
  prtgrn '
     —»«  ‘„«—Â '$ID' »« „Ê›ﬁÌ  Õ–› ‘œ <<
  >> Bot number '$ID' seccessfuly deleted.
'
  exit
}
# install Bot
install() {
  prtgrn '
         ¬Ì« ﬁ’œ ‰’» ÅÌ‘ ‰Ì«“ Â«Ì —»«   »·Ì€ùê— —« œ«—Ìœø »·Â|ŒÌ— <<
  >> Do you want to install Essentials of Bot? (Y/N):
'
  read -rp ' ' install
  case "$install" in
    Y|y|»·Â)
      prtgrn "
         telegram-cli »«—êÌ—Ì <<
 >> Fetching $TDCLI
"
      wget "$TDCLI" -O telegram-cli
      chmod +x telegram-cli
      prtgrn "
     «— ﬁ«Ì «ÿ·«⁄«  ﬁœÌ„Ì <<
 >> Updating old packages
"
      sudo apt-get -y update && sudo apt-get -y upgrade 
      prtgrn "
        ‰’» »” Â Â«Ì ÅÌ‘ ‰Ì«“Ì <<
 >> Installing Essentials packages
"
      sudo apt-get --force-yes install git wget screen tmux libconfig9 libevent-dev libjansson4 libstdc++6 lua-socket lua5.2 liblua5.2 make unzip redis-server software-properties-common g++
      sudo apt-get -y update && sudo apt-get -y upgrade
      sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test && sudo apt-get update && sudo apt-get install -y gcc-4.9 g++-4.9 && sudo update-alternatives óinstall /usr/bin/gcc gcc /usr/bin/gcc-4.9 60 óslave /usr/bin/g++ g++ /usr/bin/g++-4.9
      prtgrn "
 «— ﬁ«Ì »” Â Â«Ì ‰’» ‘œÂ <<
 >> Updating packages
"
      sudo apt-get -y update && sudo apt-get -y upgrade && sudo apt-get -y dist-upgrade && sudo apt-get -y autoremove
      prtgrn "
      redis —«Â «‰œ«“Ì „Ãœœ  <<
 >> Restarting redis service
"
      sudo service redis-server restart
      prtgrn '
      Â„ê«„ ”«“Ì »« ÃœÌœ —Ì‰ ‰”ŒÂ  »·Ì€ùê— << 
 >> Fetching latest Bot source code
 '
      git pull
      prtgrn '
      ‰’» ÅÌ‘ ‰Ì«“ Â«Ì —»«   »·Ì€ùê— »« „Ê›ﬁÌ  «‰Ã«„ ‘œ << 
 >> Essentials of Tablighgar Bot successfully installed!
 '
      printf '\e[1;33m»”«“Ìœ\e[1;32m ./bot create \e[1;33m—»«   »·Ì€ùê— ŒÊœ —« »« œ” Ê— <<\e[1;33m%s\n >>Create Your bot with\e[1;32m ./bot create\e[0;39;49m%s\n'
    ;;
    N|n|ŒÌ—)
      prtbrown '
        ·€Ê ⁄„·Ì« 
 Canceling the operation
 '
    ;;
    *)
      prtred '
    œ” Ê— «‘ »«Â
  Wrong command
 '
      install
    ;;
  esac
}
# How to use this script
usage() {
printf "\e[1;36m"
  cat <<EOF
  
                    $0 [„Ê«—œ «” ›«œÂ  : [ê“Ì‰Â Â« <<
                                        : ê“Ì‰Â Â«
        ‘„«—Â             —«Â «‰œ«“Ì —»«  »« «Ì‰ ‘„«—Â 
  —«Âù«‰œ«“Ì «‰ Ì ò—‘ —»« ù»«ù«Ì‰ù‘„«—Â            a‘„«—Â
   »«“Ì«»Ì «ÿ·«⁄«  «“ «Œ—Ì‰ »—Ê“—”«‰Ì             fix
    ‰’» ÅÌ‘ ‰Ì«“ Â«Ì —»«   »·Ì€ùê—           install
      »—Ê“—”«‰Ì »Â ¬Œ—Ì‰ ‰”ŒÂ —»«             update
                 ”«Œ  —»«  ÃœÌœ           create
       ”«Œ  —»«  ÃœÌœ »’Ê—  œ” Ì        createmanual
                   ‰„«Ì‘ «Ì‰ „ ‰            help
   —«Âù«‰œ«“Ì  „«„ —»«  Â« Â— 20 œﬁÌﬁÂ          autolaunch
                  
>> Usage: $0 [options]
    Options:
      createmanual      Create a new Bot manually
      autolaunch        Launch all bots every 20 mins
      NUMBER            Start bot whit this ID number
      aNUMBER           Start bot whit this ID number in anticrash mod
      install           Install of Bot
      create            Create a new Bot
      update            Update bot source code
      help              Print this message
      fix               Reseting data
EOF
printf "%s\n\e[0;39;49m"
}
## MAIN ------------------------------------------------------------------------
# Make sure this script run inside Bot directory
cd "$THIS_DIR" || exit
case $1 in
  update)
    update
  ;;
  create)
    create
  ;;
  install)
    install
  ;;
  fix)
    fix
  ;;
  autolaunch)
    autolaunch
  ;;
  help)
    usage
  ;;
  createmanual)
    createmanual
  ;;
  a*)
    id="${1/a/}"
    if [ -a "$THIS_DIR"/bot-"$id".lua ]; then
      screen -x -s bot-"$id" quit
      while true ; do
        screen -s bot-"$id" ./telegram-cli -p bot-"$id" -s bot-"$id".lua
        sleep 10
      done
    else
      usage
    fi
  ;;
  clr)
    clear
  ;;
  *)
    if [ -a "$THIS_DIR"/bot-"$1".lua ]; then
      ./telegram-cli -p bot-"$1" -s bot-"$1".lua
    else
    usage
    fi
  ;;
esac